<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mini Map Test</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    #map { width: 100%; height: 400px; min-height: 400px;}
    html,body { height:100%; margin:0; padding:0; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.1.3/leaflet-maplibre-gl.js"></script>
<script>
    // URL paramı okuma fonksiyonu
    function getParam(name) {
        try {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        } catch {
            return null;
        }
    }
    const lat = parseFloat(getParam("lat")) || 41.01;
    const lon = parseFloat(getParam("lon")) || 29.00;
    const zoom = 14;
    const map = L.map('map').setView([lat, lon], zoom);

    // JS global error debug
    window.onerror = function(msg, src, lineno, colno, err) {
        console.error('[GLOBAL JS ERROR]', msg, src, lineno, colno, err);
    };
    window.addEventListener('unhandledrejection', function(e) {
        console.error('[GLOBAL PROMISE ERROR]', e.reason || e);
    });

    // PROXY PATCH: Vektör Tile Layer ekle (tiles + url patch)
    fetch('https://tiles.openfreemap.org/styles/bright')
        .then(res => {
            if (!res.ok) throw new Error('Style JSON fetch failed ' + res.status);
            return res.json();
        })
        .then(style => {
            // Tüm kaynakları PATCH et ve logla (hem url hem tiles)
            Object.entries(style.sources).forEach(([src, obj]) => {
                console.log('[DEBUG][BEFORE PATCH]', src, 'url:', obj.url, 'tiles:', obj.tiles);
                // Vektör tile endpointinde "tiles" arrayı varsa patch!
                if (Array.isArray(obj.tiles)) {
                    obj.tiles = ['/api/tile/{z}/{x}/{y}.pbf'];
                    console.log('[DEBUG][PATCHED][tiles]', src, obj.tiles);
                }
                // Bazı style'larda url kullanılır; onu da patchle!
                if (obj.url) {
                    obj.url = '/api/tile/{z}/{x}/{y}.pbf';
                    console.log('[DEBUG][PATCHED][url]', src, obj.url);
                }
            });
            console.log('[DEBUG][PATCH RESULT] All sources:', style.sources);

            // Haritayı kur
            try {
                const maplibreLayer = L.maplibreGL({ style });
                maplibreLayer.addTo(map);

                // Vektör tile eventleri (bazen çalışmaz!)
                maplibreLayer.on('tileload', function(e) {
                    console.log('[DEBUG][TILE LOAD]', e.tile?.src || e.tile?._src || e);
                });
                maplibreLayer.on('tileerror', function(e) {
                    console.error('[DEBUG][TILE ERROR]', e.tile?.src || e.tile?._src || e);
                });
            } catch (err) {
                console.error('[MAPLIBRE ERROR] Layer eklerken hata:', err);
            }
        })
        .catch(err => {
            console.error('[PROXY ERROR] Style veya Tile Proxy hatası:', err);
        });

    // Marker ekle
    try {
        L.marker([lat, lon]).addTo(map);
    } catch (err) {
        console.error('[MARKER ERROR]', err);
    }
</script>
</body>
</html>