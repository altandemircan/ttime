<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>OpenFreeMap – Single Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link href="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.css" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden; /* Kaydırma çubuklarını gizle */
    }
    #map {
      width: 100%;
      height: 100%;
      border-radius: 0;
      position: relative;
    }
    /* Marker için özel konumlandırma */
    .leaflet-marker-icon {
      z-index: 1000 !important;
    }
    /* Marker'ın daha belirgin olması için */
    .leaflet-div-icon {
      background: transparent !important;
      border: none !important;
    }
    /* Harita iframe'i için ek CSS */
.leaflet-mini-map {
    border-radius: 8px;
    overflow: hidden;
    background: #f8f9fa;
    position: relative;
}

/* Marker'ın daha görünür olması için */
.steps .visual iframe {
    min-height: 235px;
}

/* Harita yüklenirken loading efekti */
.leaflet-mini-map.loading {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
}

@keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* Harita kontrolleri için */
.leaflet-control-container {
    position: relative;
    z-index: 10;
}
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.1.3/leaflet-maplibre-gl.js"></script>
<script>
  // Parametre oku
  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  const lat = parseFloat(getParam("lat")) || 41.01;
  const lon = parseFloat(getParam("lon")) || 29.00;
  const zoom = 14;

  // Haritayı oluştur - zoomControl false ama attributionControl true yapalım
  const map = L.map('map', { 
    zoomControl: false, 
    attributionControl: false,
    tap: false, // Mobil dokunma için optimizasyon
    preferCanvas: true // Performans için
  }).setView([lat, lon], zoom);

  // Harita kontrollerini özelleştirelim
  L.control.zoom({
    position: 'topright'
  }).addTo(map);

  // Maplibre vektör katmanı ekle
  map.whenReady(() => {
    fetch('https://tiles.openfreemap.org/styles/bright')
      .then(res => res.json())
      .then(style => {
        // Harita stilini özelleştirelim
        const customStyle = {
          ...style,
          // Marker'ın daha görünür olması için
          layers: style.layers.map(layer => {
            if (layer.id === 'background') {
              return {
                ...layer,
                paint: {
                  'background-color': '#f8f9fa'
                }
              };
            }
            return layer;
          })
        };

        L.maplibreGL({
          style: customStyle,
          interactive: true,
          preserveDrawingBuffer: true // Performans için
        }).addTo(map);

        // Custom kırmızı marker ekle - daha görünür yapalım
        const redMarkerHtml = `
          <div style="
            background:#d32f2f;
            width:32px; height:32px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            border:3px solid #fff; 
            box-shadow:0 3px 10px rgba(0,0,0,0.5);
            transform: translate(-50%, -50%);
            position: absolute;
            top: 50%;
            left: 50%;
            z-index: 1000;">
              <div style="width:10px; height:10px; background:#fff; border-radius:50%;"></div>
          </div>
        `;
        
        const marker = L.marker([lat, lon], {
          icon: L.divIcon({
            html: redMarkerHtml,
            className: 'custom-marker-icon',
            iconSize: [40, 40], // Biraz daha büyük
            iconAnchor: [20, 40], // Marker'ın tam ortasından tutması için
            popupAnchor: [0, -40]
          }),
          zIndexOffset: 1000 // Diğer katmanların üstünde
        }).addTo(map);

        // Haritayı marker'ın etrafına odakla
        map.setView([lat, lon], zoom, {
          animate: false
        });

        // Boyut düzeltmesi - daha güvenli
        setTimeout(() => {
          map.invalidateSize(true);
          // Marker'ı tekrar güncelle
          marker.update();
          
          // Ebeveyn iframe'e haritanın hazır olduğunu bildir
          try {
            window.parent.postMessage({
              type: 'mapReady',
              lat: lat,
              lon: lon
            }, '*');
          } catch(e) {
            console.log('Parent communication not available');
          }
        }, 100);

        // Ek bir kontrol: harita hareket ettikten sonra marker'ı merkeze al
        map.on('moveend', () => {
          setTimeout(() => {
            map.setView([lat, lon], map.getZoom(), { animate: false });
          }, 50);
        });

        // Performans için: harita yüklendikten sonra bazı optimizasyonlar
        setTimeout(() => {
          map.options.fadeAnimation = false;
          map.options.markerZoomAnimation = false;
        }, 500);

      })
      .catch(err => {
        console.error('Map loading error:', err);
        // Hata durumunda basit bir tile layer ekle
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Basit bir marker ekle
        L.marker([lat, lon]).addTo(map);
        map.invalidateSize(true);
      });
  });

  // Iframe içindeyken scroll olayını engelle
  document.addEventListener('wheel', function(e) {
    if (!e.ctrlKey) {
      e.preventDefault();
    }
  }, { passive: false });
</script>
</body>
</html>