<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mini Map Test</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    #map { width: 100%; height: 400px; min-height: 400px;}
    html,body { height:100%; margin:0; padding:0; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.1.3/leaflet-maplibre-gl.js"></script>
  <script>
    function getParam(name) {
      try {
        const url = new URL(window.location.href);
        return url.searchParams.get(name);
      } catch {
        return null;
      }
    }
    const lat = parseFloat(getParam("lat")) || 41.01;
    const lon = parseFloat(getParam("lon")) || 29.00;
    const zoom = 14;

    const map = L.map('map').setView([lat, lon], zoom);

    // PROXY PATCH: Vektör Tile Layer ekle (proxy + hata logu)
    fetch('https://tiles.openfreemap.org/styles/bright')
      .then(res => {
        if (!res.ok) throw new Error('Style JSON fetch failed ' + res.status);
        return res.json();
      })
      .then(style => {
        Object.keys(style.sources).forEach(src => {
          if (style.sources[src].url)
            style.sources[src].url = '/api/tile/{z}/{x}/{y}.pbf';
        });
        console.log('[Proxy PATCH] Style source:', style.sources);

        const maplibreLayer = L.maplibreGL({ style });

        maplibreLayer.on('tileload', function(e) {
          console.log('[Proxy TILE LOAD]', e.tile?.src || e.tile?._src || e);
        });
        // HATA LOGU!
        maplibreLayer.on('tileerror', function(e) {
          console.error('[PROXY ERROR] Tile yüklenemedi! src:', e.tile?.src || e.tile?._src || e);
        });

        maplibreLayer.addTo(map);
      })
      .catch(err => {
        // Style JSON proxy hata logu
        console.error('[PROXY ERROR] Harita style veya tile proxy hatası:', err);
      });

    L.marker([lat, lon]).addTo(map);
  </script>
</body>
</html>