<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mini Map Test</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <style>
    #map { width: 100%; height: 400px; min-height: 400px;}
    html,body { height:100%; margin:0; padding:0; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.1.3/leaflet-maplibre-gl.js"></script>
 <script>
    // URL paramını oku
    function getParam(name) {
        try {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        } catch {
            return null;
        }
    }
    const lat = parseFloat(getParam("lat")) || 41.01;
    const lon = parseFloat(getParam("lon")) || 29.00;
    const zoom = 14;

    // Leaflet harita başlatılıyor
    const map = L.map('map').setView([lat, lon], zoom);

    // Harita stilini OpenFreeMap'ten çek, proxyye patch et, debug logla
    fetch('https://tiles.openfreemap.org/styles/bright')
        .then(res => {
            if (!res.ok) throw new Error('Style JSON fetch failed ' + res.status);
            return res.json();
        })
        .then(style => {
            // --- DEBUG: kaynak adlarını, url'leri göster ---
            Object.entries(style.sources).forEach(([src, obj]) => {
                console.log('[DEBUG][BEFORE PATCH] Source name:', src, 'tile url:', obj.url);
                if (obj.url) {
                    obj.url = '/api/tile/{z}/{x}/{y}.pbf'; // Burada patch
                    console.log('[DEBUG][PATCHED] Source name:', src, 'tile url:', obj.url);
                }
            });

            // --- DEBUG: Sonuç kaynakları göster ---
            console.log('[DEBUG][PATCH RESULT] Tüm kaynaklar:', style.sources);

            // Harita Layer'ı ekle
            try {
                const maplibreLayer = L.maplibreGL({ style });
                maplibreLayer.addTo(map);

                // Vektör tile layerde olaylar (loglamak için)
                // NOT: Çoğu browser, tileload/tileerror eventlerini vektör tile'da tetiklemez!
                maplibreLayer.on('tileload', function(e) {
                    console.log('[DEBUG][TILE LOAD] Tile yükleniyor:', e.tile?.src || e.tile?._src || e);
                });
                maplibreLayer.on('tileerror', function(e) {
                    console.error('[DEBUG][TILE ERROR] Tile yüklenemedi:', e.tile?.src || e.tile?._src || e);
                });
            } catch (err) {
                console.error('[MAPLIBRE ERROR] Layer eklerken hata oluştu:', err);
            }
        })
        .catch(err => {
            // Style, tile veya fetch hatası olursa
            console.error('[PROXY ERROR] Harita style veya tile proxy hatası:', err);
        });

    // Marker ekle
    L.marker([lat, lon]).addTo(map);

    // Genel JS errorları için de log
    window.onerror = function(msg, src, lineno, colno, err) {
        console.error('[GLOBAL JS ERROR]', msg, src, lineno, colno, err);
    }
    window.addEventListener('unhandledrejection', function(e) {
        console.error('[GLOBAL PROMISE ERROR]', e.reason || e);
    });
</script>
</body>
</html>