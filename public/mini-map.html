<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>OpenFreeMap – Single Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link href="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.css" rel="stylesheet">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #map {
      width: 100%;
      height: 100%;
      border-radius: 0;
    }
    /* MARKER KESİNLİKLE SABİT KALSIN */
    .leaflet-marker-icon {
      z-index: 9999 !important;
      pointer-events: auto !important;
    }
  </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/maplibre-gl@3.5.2/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@maplibre/maplibre-gl-leaflet@0.1.3/leaflet-maplibre-gl.js"></script>
<script>
  // Parametre oku
  function getParam(name) {
    const url = new URL(window.location.href);
    return url.searchParams.get(name);
  }
  const lat = parseFloat(getParam("lat")) || 41.01;
  const lon = parseFloat(getParam("lon")) || 29.00;
  const zoom = 14;

  // HARİTAYI OLUŞTUR - MARKER ÖNCE EKLENSİN
  const map = L.map('map', { 
    zoomControl: false, 
    attributionControl: false,
    zoomAnimation: false, // ANİMASYONU KAPAT
    fadeAnimation: false, // FADE ANİMASYONUNU KAPAT
    markerZoomAnimation: false // MARKER ZOOM ANİMASYONUNU KAPAT
  });

  // ÖNCE MARKER'I EKLE
  const redMarkerHtml = `
    <div style="
      background:#d32f2f;
      width:32px; height:32px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      border:2px solid #fff; 
      box-shadow:0 2px 10px rgba(0,0,0,0.5);
      position:relative;
      z-index:9999;">
        <div style="width:8px; height:8px; background:#fff; border-radius:50%;"></div>
    </div>
  `;
  
  const marker = L.marker([lat, lon], {
    icon: L.divIcon({
      html: redMarkerHtml,
      className: '',
      iconSize: [32, 32],
      iconAnchor: [16, 32], // ALT KISIMDAN TUTSUN
      popupAnchor: [0, -32]
    }),
    zIndexOffset: 9999, // EN ÜSTTE OLSUN
    interactive: true
  }).addTo(map);

  // MARKER EKLENDİKTEN SONRA HARİTA KATMANINI EKLE
  map.whenReady(() => {
    fetch('https://tiles.openfreemap.org/styles/bright')
      .then(res => res.json())
      .then(style => {
        L.maplibreGL({
          style: style,
          interactive: true
        }).addTo(map);

        // VIEW'İ AYARLA - MARKER MERKEZDE OLSUN
        map.setView([lat, lon], zoom, { 
          animate: false, // ANİMASYON YOK
          reset: true 
        });

        // BOYUTU KESİN DÜZELT - 3 KEZ ÇAĞIR GARANTİ OLSUN
        setTimeout(() => {
          map.invalidateSize({ pan: false });
          map.setView([lat, lon], zoom, { animate: false });
          
          setTimeout(() => {
            map.invalidateSize({ pan: false });
            map.setView([lat, lon], zoom, { animate: false });
            
            setTimeout(() => {
              map.invalidateSize({ pan: false });
              // MARKER'I TEKRAR GÜNCELLE
              marker.setLatLng([lat, lon]);
            }, 50);
          }, 50);
        }, 100);

        // HARİTA HAREKET ETTİĞİNDE MARKER'I SABİT TUT
        map.on('move', function() {
          // MARKER'IN POZİSYONUNU KORU
          marker.setLatLng([lat, lon]);
        });

        // ZOOM YAPILIRSA MARKER SABİT KALSIN
        map.on('zoom', function() {
          marker.setLatLng([lat, lon]);
        });

      })
      .catch(err => {
        console.error('Map error:', err);
        // HATA DURUMUNDA SADECE MARKER GÖSTER
        map.setView([lat, lon], zoom, { animate: false });
        map.invalidateSize({ pan: false });
      });
  });

  // İLK VIEW AYARI - MARKER MERKEZDE
  map.setView([lat, lon], zoom, { animate: false });
</script>
</body>
</html>